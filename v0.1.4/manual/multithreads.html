<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Multi threads · Microstructure.jl</title><meta name="title" content="Multi threads · Microstructure.jl"/><meta property="og:title" content="Multi threads · Microstructure.jl"/><meta property="twitter:title" content="Multi threads · Microstructure.jl"/><meta name="description" content="Documentation for Microstructure.jl."/><meta property="og:description" content="Documentation for Microstructure.jl."/><meta property="twitter:description" content="Documentation for Microstructure.jl."/><script data-outdated-warner src="../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../assets/documenter.js"></script><script src="../search_index.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><a class="docs-logo" href="../index.html"><img src="../assets/logo.png" alt="Microstructure.jl logo"/></a><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../index.html">Home</a></li><li><a class="tocitem" href="../getting_started.html">Getting started</a></li><li><span class="tocitem">Manual</span><ul><li><a class="tocitem" href="dMRI.html">I/O functions</a></li><li><a class="tocitem" href="compartments.html">Tissue Compartments</a></li><li><a class="tocitem" href="models.html">Microstructure Models</a></li><li><a class="tocitem" href="estimators.html">Estimators</a></li><li class="is-active"><a class="tocitem" href="multithreads.html">Multi threads</a></li></ul></li><li><span class="tocitem">Tutorials</span><ul><li><a class="tocitem" href="../tutorials/1_build_models.html">How to build a microstructure model</a></li><li><a class="tocitem" href="../tutorials/2_quality_of_fit.html">How to check quality of fitting and mcmc samples</a></li><li><a class="tocitem" href="../tutorials/3_data_generation.html">How to generate training datasets</a></li><li><a class="tocitem" href="../tutorials/4_noise_propagation.html">How to evaluate accuracy and precision</a></li><li><a class="tocitem" href="../tutorials/5_model_selection.html">Which model to use</a></li></ul></li><li><a class="tocitem" href="../guide.html">Developer guide</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Manual</a></li><li class="is-active"><a href="multithreads.html">Multi threads</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href="multithreads.html">Multi threads</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/Tinggong/Microstructure.jl" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/Tinggong/Microstructure.jl/blob/main/docs/src/manual/multithreads.md" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="Multi-threads"><a class="docs-heading-anchor" href="#Multi-threads">Multi threads</a><a id="Multi-threads-1"></a><a class="docs-heading-anchor-permalink" href="#Multi-threads" title="Permalink"></a></h1><p>Multi-threads processing is recommended when using MCMC estimation. The neural network estimators are relatively fast and take only minutes training on CPU. </p><h3 id="Start-julia-in-terminal-with-multi-threads"><a class="docs-heading-anchor" href="#Start-julia-in-terminal-with-multi-threads">Start julia in terminal with multi-threads</a><a id="Start-julia-in-terminal-with-multi-threads-1"></a><a class="docs-heading-anchor-permalink" href="#Start-julia-in-terminal-with-multi-threads" title="Permalink"></a></h3><pre><code class="language-terminal hljs">~ % julia --threads auto</code></pre><p>You can also set enviornment variable by adding <code>export JULIA_NUM_THREADS=auto</code> in your bash profile, which will use multi-threads automatically when you start julia.</p><h3 id="Multi-threads-for-MCMC-estimation"><a class="docs-heading-anchor" href="#Multi-threads-for-MCMC-estimation">Multi-threads for MCMC estimation</a><a id="Multi-threads-for-MCMC-estimation-1"></a><a class="docs-heading-anchor-permalink" href="#Multi-threads-for-MCMC-estimation" title="Permalink"></a></h3><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Microstructure.threading" href="#Microstructure.threading"><code>Microstructure.threading</code></a> — <span class="docstring-category">Function</span></header><section><div><p>This method runs multi-threads MCMC estimation on dMRI data using a specified biophysical model, calls the voxel threading  method introduced in (2) and save estimated parameters as nifti files. &quot;savedir&quot; can include both output path and file name prefix. Two-stage MCMC sampling methods are run if provided sampler is a Tuple of two samplers, where it will sample all the unknown parameters  using the first sampler then sample target tissue parameters in the second sampler while fixing the rest parameters to posterior means in the first MCMC.  </p><pre><code class="nohighlight hljs">threading(
    model_start::BiophysicalModel,
    sampler::Union{Sampler,Tuple{Sampler,Sampler}},
    dmri::MRI,
    mask::MRI,
    protocol::Protocol,
    noise_model::Noisemodel,
    savedir::String,
)</code></pre><p>Methods that return mean and standard deviation of estimations from measurements array of size [Nmeas, Nvoxels] using single-stage or two-stage MCMC.</p><pre><code class="nohighlight hljs">threading(
    model_start::BiophysicalModel,
    sampler::Sampler,
    measurements::Array{Float64,2},
    protocol::Protocol,
    noise_model::Noisemodel,
)


threading(
    model_start::BiophysicalModel,
    sampler::Tuple{Sampler,Sampler},
    measurements::Array{Float64,2},
    protocol::Protocol,
    noise_model::Noisemodel,
)</code></pre></div><a class="docs-sourcelink" target="_blank" href="https://github.com/Tinggong/Microstructure.jl/blob/31f28d39dd9dfc05cb233c8a27bcbf8bb5fd98c2/src/threading.jl#L4-L39">source</a></section></article><p>Function threading calls pre_allocate and mcmc! for multi-threads processing. When provided sampler is a Tuple containing two Samplers, it uses a two-stage MCMC to get final estimates.</p><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Microstructure.pre_allocate" href="#Microstructure.pre_allocate"><code>Microstructure.pre_allocate</code></a> — <span class="docstring-category">Function</span></header><section><div><pre><code class="language-julia hljs">pre_allocate(
    model::BiophysicalModel, sampler::Sampler, datasize::Tuple{Int64,Int64}
)

pre_allocate(
    model::BiophysicalModel, sampler::Tuple{Sampler,Sampler}, datasize::Tuple{Int64,Int64}
)</code></pre><p>Allocating spaces for caching computing results based on &#39;model&#39;, &#39;sampler&#39; and &#39;datasize&#39;. &#39;datasize&#39; is the size of data (Nmeas, Nvoxels) </p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/Tinggong/Microstructure.jl/blob/31f28d39dd9dfc05cb233c8a27bcbf8bb5fd98c2/src/threading.jl#L175-L185">source</a></section></article></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="estimators.html">« Estimators</a><a class="docs-footer-nextpage" href="../tutorials/1_build_models.html">How to build a microstructure model »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.4.0 on <span class="colophon-date" title="Wednesday 1 May 2024 16:01">Wednesday 1 May 2024</span>. Using Julia version 1.8.5.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
